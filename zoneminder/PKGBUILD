
# Contributor: Troy Will                 <troydwill@gmail.com>
# Contributor: /dev/rs0                  </dev/rs0@secretco.de.com>
# Contributor: Jacek Burghardt           <jacek@hebe.us>
# Contributor: Vojtech Aschenbrenner     <v@asch.cz>
# Contributor: Jason Gardner             <buhrietoe@gmail.com>
# Contributor: Ross melin                <rdmelin@gmail.com>
# Contributor (Parabola): Márcio Silva   <coadde@lavabit.com>
# Contributor (Parabola): André Silva    <emulatorman@lavabit.com>
# Orginally based on a Debian Squeeze package

pkgbase=zoneminder
pkgname=zoneminder
pkgver=1.27.0
pkgrel=3
pkgdesc='Capture, analyse, record and monitor video security cameras'
arch=( i686 x86_64 mips64el arm )

backup=( etc/zm.conf )
url="https://github.com/ZoneMinder/ZoneMinder/releases"
license=( GPL )

depends=(
    apache
    cambozola
    gnutls
    mariadb
    perl-archive-zip
    perl-date-manip
    perl-dbd-mysql
    perl-dbi
    perl-expect
    perl-libwww
    perl-mime-lite
    perl-mime-tools
    perl-php-serialization
    perl-net-sftp-foreign
    perl-sys-mmap
    perl-time-modules
    perl-x10
    php
    php-apache
    php-gd
    php-mcrypt
)

makedepends=(
    netpbm
)

optdepends=(
    netpbm
)

install=$pkgbase.install

source=(
    https://github.com/ZoneMinder/ZoneMinder/archive/v$pkgver.tar.gz
    httpd-zoneminder.conf
    zoneminder
    zoneminder.service
    zoneminder.php.ini.sed
    zoneminder.httpd.conf.sed
)

sha512sums=(
 '8a349558399381a9062365ddc8bd8f815e3800929914096b2e4ea63e4d6dd12054f7b849fab5bea4bcfc87ea60739479a55734c7075a74aab0622d35f1d2bb14'
 'fb9bf263c37fae30d775872a33cb319f2f2a7a4f38faff8c143253dbefd7278b295d0805e11ace6423a8ec2b50ef60f3426b6e6a53548c867ef7f109baa52c36'
 '5454a283ccb656ff21ab4030e3a5eabd15d7415e082fd24bb894e493f881fe1e2d2ca6536bac8b54845940b87b609a0e9d2afa0c0b605860bd650b83a6f7a562'
 'd04aede00d2f008e7851f69a62633f27d4f747b6fa4350e3096415cc7c2659d677707af3e397295010fa05794ff9cbb995c3904e6989ebfbd58ba6b4bfcc002c'
 'a4a7e6b9344ab68951831af5d258f2595f73be0b41a9ff84e4f2ebf8ae183278f6c160d045dc9a1742349f3cf8997db33c9747d8a4661c978d626eeab523e0c5'
 '13e44e378de505ce07b5e19489334f5a03dbc60b43fa4d3f4d7255b81abefcd95dd592ee4d09bd2c44c14befb1b155e00874cea6da569e7d0eb4633e61a1608e'
)

build() {
    cd $srcdir/ZoneMinder-$pkgver
    ./bootstrap.sh

    export CXXFLAGS=-D__STDC_CONSTANT_MACROS
    ./configure --prefix=/usr \
        --enable-crashtrace=no \
        --enable-debug=no \
        --enable-mmap=yes \
        --sysconfdir=/etc \
        --with-cgidir=/srv/http/cgi-bin \
        --with-extralibs='-L/usr/lib -L/usr/lib/mysql' \
        --with-libarch=lib \
        --with-ffmpeg=/usr \
        --with-mysql=/usr \
        --with-webdir=/srv/http/$pkgbase \
        --with-webgroup=http \
        --with-webhost=localhost \
        --with-webuser=http \
        
    make V=0
}

package() {
    cd $srcdir/ZoneMinder-$pkgver

    make DESTDIR=$pkgdir install

    mkdir -p $pkgdir/{etc/{httpd/conf/extra,rc.d},srv/http/{cgi-bin,$pkgbase},usr/{lib/systemd/system,share/{license/$pkgbase,$pkgbase/db}},var/{cache/$pkgbase,log/$pkgbase}}
    mkdir -p $pkgdir/srv/zoneminder/socks
    chown -R http.http $pkgdir/{etc/zm.conf,var/{cache/$pkgbase,log/$pkgbase}}
    chown -R http.http $pkgdir/srv/zoneminder/socks
    chmod 0700 $pkgdir/etc/zm.conf

    for i in events images temp; do
        mv    $pkgdir/srv/http/$pkgbase/$i $pkgdir/var/cache/$pkgbase/$i
        ln -s /var/cache/$pkgbase/$i       $pkgdir/srv/http/$pkgbase/$i
        chown -h http.http                 $pkgdir/srv/http/$pkgbase/$i
    done

    ln -s /srv/http/cgi-bin                  $pkgdir/srv/http/$pkgbase
    chown -h http.http                       $pkgdir/srv/http/{cgi-bin,$pkgbase,$pkgbase/cgi-bin}

    ln -s /usr/share/cambozola/cambozola.jar $pkgdir/srv/http/$pkgbase
    
    install -D -m 644 $srcdir/httpd-$pkgbase.conf $pkgdir/etc/httpd/conf/extra
    install -D -m 644 $srcdir/$pkgbase            $pkgdir/etc/rc.d
    install -D -m 644 $srcdir/$pkgbase.service    $pkgdir/usr/lib/systemd/system
    install -D -m 644 COPYING                     $pkgdir/usr/share/license/$pkgbase
    install -D -m 644 db/zm*.sql                  $pkgdir/usr/share/$pkgbase/db
}
